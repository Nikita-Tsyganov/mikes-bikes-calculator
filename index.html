<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="Description" content="Mike's Bikes Utilities" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#FFFFFF" />
    <meta charset="utf-8" />
    <title>Mike's Bikes Utilities</title>
    <link rel="stylesheet" type="text/css" href="bulma.min.css" />
    <style type="text/css">
      .mb-1 {
        margin-bottom: 5px !important;
      }
      .mb-2 {
        margin-bottom: 10px !important;
      }
      .mb-3 {
        margin-bottom: 15px !important;
      }
      .mb-4 {
        margin-bottom: 20px !important;
      }
      .mb-5 {
        margin-bottom: 25px !important;
      }
      .mb-6 {
        margin-bottom: 30px !important;
      }
      .text-bold {
        font-weight: 600;
      }
      .budget {
        display: grid;
        grid-template-columns: 100%;
        grid-template-rows: auto;
        grid-column-gap: 20px;
      }
      .content {
        margin: 0 auto;
        padding: 20px;
        max-width: 530px;
      }
      .has-addons .control .input {
        border-left: none !important;
      }
      .label {
        font-weight: 600;
      }
      .help.help.help {
        margin: 2px 0 7.5px 0;
      }
      @media screen and (min-width: 531px) {
        .budget {
          grid-template-columns: 150px 150px 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="content">
      <div class="field mb-5">
        <label class="label">Choose segment:</label>
        <div class="control is-marginless">
          <div class="select">
            <select id="segment">
              <option value="none">No segment</option>
              <option value="road">Road</option>
              <option value="mountain">Mountain</option>
              <option value="youth">Youth</option>
            </select>
          </div>
        </div>
      </div>

      <label class="label is-marginless"
        >You can take a shortcut here and...</label
      >
      <label class="label">Get the best result for this amount:</label>
      <div class="field has-addons mb-1">
        <p class="control is-marginless">
          <a class="button is-static">
            $
          </a>
        </p>
        <div class="control">
          <input
            id="getBestResultsBudget"
            type="number"
            min="0"
            max="8400000"
            step="50000"
            name="getBestResultsBudget"
            value="0"
            placeholder="0"
            class="input"
          />
        </div>
        <div class="control">
          <a id="getBestResultBtn" class="button is-info">
            Submit
          </a>
        </div>
      </div>
      <p class="help">
        Shows the best possible choice for the provided amount
        <br />
        Calculates using the [Coverage X Efficiency] formula
      </p>
      <div class="field mb-2">
        <div class="control">
          <label class="checkbox">
            <input id="autoRecalc" type="checkbox" checked />
            Automatically recalculate the best choice on segment change
          </label>
          <p class="help">
            If unchecked, the best choice will not be
            <br />
            automatically recalculated on segment change
          </p>
        </div>
      </div>
      <div class="field mb-6">
        <div class="control">
          <label class="checkbox">
            <input id="strictBudgetMatch" type="checkbox" checked />
            Match the allocated amount exactly
          </label>
          <p class="help">
            If unchecked, gives the best closest choice according to
            <br />
            the formula rather than forcing the use of the whole amount
          </p>
        </div>
      </div>

      <div class="mb-6">
        Input the amount of money you want to allocate for each channel
        <br />
        Minimum amount is 0
        <br />
        Maximum amount is 2800000
        <br />
        Minimal acceptable step is 50000
        <br />
        <p class="help">
          *Efficiency refers to how much coverage you get per $50000 of your
          investment
        </p>
      </div>

      <div class="budget mb-2">
        <div class="budget__tv mb-4">
          <label class="label">TV:</label>
          <div class="field has-addons is-marginless">
            <p class="control is-marginless">
              <a class="button is-static">
                $
              </a>
            </p>
            <p class="control is-marginless">
              <input
                id="tv"
                type="number"
                min="0"
                max="2800000"
                step="50000"
                name="tv"
                value="0"
                placeholder="0"
                class="input"
              />
            </p>
          </div>
          <div id="tvCoverage">&nbsp;</div>
          <div id="tvEff">&nbsp;</div>
        </div>

        <div class="budget__internet mb-4">
          <label class="label">Internet:</label>
          <div class="field has-addons is-marginless">
            <p class="control is-marginless">
              <a class="button is-static">
                $
              </a>
            </p>
            <p class="control is-marginless">
              <input
                id="internet"
                type="number"
                min="0"
                max="2800000"
                step="50000"
                name="internet"
                value="0"
                placeholder="0"
                class="input"
              />
            </p>
          </div>
          <div id="internetCoverage">&nbsp;</div>
          <div id="internetEff">&nbsp;</div>
        </div>

        <div class="budget__magazines mb-4">
          <label class="label">Magazines:</label>
          <div class="field has-addons is-marginless">
            <p class="control is-marginless">
              <a class="button is-static">
                $
              </a>
            </p>
            <p class="control is-marginless">
              <input
                id="magazines"
                type="number"
                min="0"
                max="2800000"
                step="50000"
                name="magazines"
                value="0"
                placeholder="0"
                class="input"
              />
            </p>
          </div>
          <div id="magazinesCoverage">&nbsp;</div>
          <div id="magazinesEff">&nbsp;</div>
        </div>
      </div>

      <div class="summary mb-5">
        <div class="mb-1 text-bold">Overall stats:</div>
        <div id="budget">&nbsp;</div>
        <div id="coverage">&nbsp;</div>
        <div id="costEfficiency">&nbsp;</div>
      </div>
    </div>
  </body>
  <script>
    const tvStats = {
      "0": 0,
      "50000": 0.25,
      "100000": 0.5,
      "150000": 0.75,
      "200000": 1,
      "250000": 1.9,
      "300000": 2.8,
      "350000": 3.7,
      "400000": 4.6,
      "450000": 5.95,
      "500000": 7.3,
      "550000": 8.65,
      "600000": 10,
      "650000": 11.55,
      "700000": 13.1,
      "750000": 14.65,
      "800000": 16.2,
      "850000": 17.675,
      "900000": 19.15,
      "950000": 20.625,
      "1000000": 22.1,
      "1050000": 23.375,
      "1100000": 24.65,
      "1150000": 25.925,
      "1200000": 27.2,
      "1250000": 28.25,
      "1300000": 29.3,
      "1350000": 30.35,
      "1400000": 31.4,
      "1450000": 32.225,
      "1500000": 33.05,
      "1550000": 33.875,
      "1600000": 34.7,
      "1650000": 35.375,
      "1700000": 36.05,
      "1750000": 36.725,
      "1800000": 37.4,
      "1850000": 37.925,
      "1900000": 38.45,
      "1950000": 38.975,
      "2000000": 39.5,
      "2050000": 39.925,
      "2100000": 40.35,
      "2150000": 40.775,
      "2200000": 41.2,
      "2250000": 41.525,
      "2300000": 41.85,
      "2350000": 42.175,
      "2400000": 42.5,
      "2450000": 42.775,
      "2500000": 43.05,
      "2550000": 43.325,
      "2600000": 43.6,
      "2650000": 43.825,
      "2700000": 44.05,
      "2750000": 44.275,
      "2800000": 44.5
    };
    const internetStats = {
      "0": 0,
      "50000": 0.275,
      "100000": 0.55,
      "150000": 0.825,
      "200000": 1.1,
      "250000": 2.45,
      "300000": 3.8,
      "350000": 5.15,
      "400000": 6.5,
      "450000": 8.775,
      "500000": 11.05,
      "550000": 13.325,
      "600000": 15.6,
      "650000": 17.95,
      "700000": 20.3,
      "750000": 22.65,
      "800000": 25,
      "850000": 26.85,
      "900000": 28.7,
      "950000": 30.55,
      "1000000": 32.4,
      "1050000": 33.725,
      "1100000": 35.05,
      "1150000": 36.375,
      "1200000": 37.7,
      "1250000": 38.575,
      "1300000": 39.45,
      "1350000": 40.325,
      "1400000": 41.2,
      "1450000": 41.775,
      "1500000": 42.35,
      "1550000": 42.925,
      "1600000": 43.5,
      "1650000": 43.9,
      "1700000": 44.3,
      "1750000": 44.7,
      "1800000": 45.1,
      "1850000": 45.4,
      "1900000": 45.7,
      "1950000": 46,
      "2000000": 46.3,
      "2050000": 46.5,
      "2100000": 46.7,
      "2150000": 46.9,
      "2200000": 47.1,
      "2250000": 47.25,
      "2300000": 47.4,
      "2350000": 47.55,
      "2400000": 47.7,
      "2450000": 47.8,
      "2500000": 47.9,
      "2550000": 48,
      "2600000": 48.1,
      "2650000": 48.2,
      "2700000": 48.3,
      "2750000": 48.4,
      "2800000": 48.5
    };
    const magazinesStats = {
      "0": 0,
      "50000": 0.975,
      "100000": 1.95,
      "150000": 2.925,
      "200000": 3.9,
      "250000": 5.4,
      "300000": 6.9,
      "350000": 8.4,
      "400000": 9.9,
      "450000": 11.35,
      "500000": 12.8,
      "550000": 14.25,
      "600000": 15.7,
      "650000": 16.975,
      "700000": 18.25,
      "750000": 19.525,
      "800000": 20.8,
      "850000": 21.85,
      "900000": 22.9,
      "950000": 23.95,
      "1000000": 25,
      "1050000": 25.875,
      "1100000": 26.75,
      "1150000": 27.625,
      "1200000": 28.5,
      "1250000": 29.2,
      "1300000": 29.9,
      "1350000": 30.6,
      "1400000": 31.3,
      "1450000": 31.875,
      "1500000": 32.45,
      "1550000": 33.025,
      "1600000": 33.6,
      "1650000": 34.075,
      "1700000": 34.55,
      "1750000": 35.025,
      "1800000": 35.5,
      "1850000": 35.9,
      "1900000": 36.3,
      "1950000": 36.7,
      "2000000": 37.1,
      "2050000": 37.45,
      "2100000": 37.8,
      "2150000": 38.15,
      "2200000": 38.5,
      "2250000": 38.775,
      "2300000": 39.05,
      "2350000": 39.325,
      "2400000": 39.6,
      "2450000": 39.85,
      "2500000": 40.1,
      "2550000": 40.35,
      "2600000": 40.6,
      "2650000": 40.8,
      "2700000": 41,
      "2750000": 41.2,
      "2800000": 41.4
    };
    const segments = {
      none: {
        tv: 1,
        internet: 1,
        magazines: 1
      },
      road: {
        tv: 0.1,
        internet: 0.4,
        magazines: 0.6
      },
      mountain: {
        tv: 0.4,
        internet: 0.3,
        magazines: 0.5
      },
      youth: {
        tv: 0.7,
        internet: 0.2,
        magazines: 0.2
      }
    };

    const segmentElement = document.getElementById("segment");
    const tvElement = document.getElementById("tv");
    const internetElement = document.getElementById("internet");
    const magazinesElement = document.getElementById("magazines");
    const budget = document.getElementById("budget");
    const coverageElement = document.getElementById("coverage");
    const costEfficiencyElement = document.getElementById("costEfficiency");
    const tvCoverageElement = document.getElementById("tvCoverage");
    const tvEffElement = document.getElementById("tvEff");
    const interneCoverageElement = document.getElementById("internetCoverage");
    const internetEffElement = document.getElementById("internetEff");
    const magazinesCoverageElement = document.getElementById(
      "magazinesCoverage"
    );
    const magazinesEffElement = document.getElementById("magazinesEff");

    const getBestResultBudgetElement = document.getElementById(
      "getBestResultsBudget"
    );
    const getBestResultBtnElement = document.getElementById("getBestResultBtn");
    const autoRecalcElement = document.getElementById("autoRecalc");
    const strictBudgetMatchElement = document.getElementById(
      "strictBudgetMatch"
    );

    window.addEventListener("load", calculate);
    segmentElement.addEventListener("input", calculate);
    segmentElement.addEventListener("input", e => {
      if (autoRecalc) {
        getBestPossibleRatio();
      }
    });
    tvElement.addEventListener("input", calculate);
    internetElement.addEventListener("input", calculate);
    magazinesElement.addEventListener("input", calculate);

    getBestResultBtnElement.addEventListener("click", getBestPossibleRatio);
    autoRecalcElement.addEventListener("input", e => {
      autoRecalc = autoRecalcElement.checked;
    });
    strictBudgetMatchElement.addEventListener("input", e => {
      strictBudgetMatch = strictBudgetMatchElement.checked;
    });

    let segment = segmentElement.value;

    let autoRecalc = true;
    let strictBudgetMatch = true;

    let tvValue = null;
    let internetValue = null;
    let magazinesValue = null;

    let tvPercentage = null;
    let internetPercentage = null;
    let magazinesPercentage = null;

    let tvCostEfficiency = null;
    let internetCostEfficiency = null;
    let magazinesCostEfficiency = null;

    let budgetValue = null;
    let coverage = null;
    let costEfficiency = null;

    let maxBudget = null;

    function calculate(e) {
      segment = segmentElement.value;

      tvValue = getTvValue();
      internetValue = getInternetValue();
      magazinesValue = getMagazinesValue();

      tvPercentage = getTvPercentage();
      internetPercentage = getInternetPercentage();
      magazinesPercentage = getMagazinesPercentage();

      tvCoverageElement.innerHTML =
        "Coverage: " + tvPercentage.toFixed(2) + "%";
      interneCoverageElement.innerHTML =
        "Coverage: " + internetPercentage.toFixed(2) + "%";
      magazinesCoverageElement.innerHTML =
        "Coverage: " + magazinesPercentage.toFixed(2) + "%";

      tvCostEfficiency = ((tvPercentage / tvValue || 0) * 50000).toFixed(4);
      internetCostEfficiency = (
        (internetPercentage / internetValue || 0) * 50000
      ).toFixed(4);
      magazinesCostEfficiency = (
        (magazinesPercentage / magazinesValue || 0) * 50000
      ).toFixed(4);

      tvEffElement.innerHTML = "Efficiency: " + tvCostEfficiency + "%";
      internetEffElement.innerHTML =
        "Efficiency: " + internetCostEfficiency + "%";
      magazinesEffElement.innerHTML =
        "Efficiency: " + magazinesCostEfficiency + "%";

      budgetValue = tvValue + internetValue + magazinesValue;
      coverage = (
        tvPercentage +
        internetPercentage +
        magazinesPercentage
      ).toFixed(2);
      costEfficiency = ((coverage / budgetValue || 0) * 50000).toFixed(4);

      budget.innerHTML = "Budget: $" + budgetValue;
      coverageElement.innerHTML = "Coverage of the segment: " + coverage + "%";
      costEfficiencyElement.innerHTML = "Efficiency: " + costEfficiency + "%";
    }

    function getTvValue() {
      return getElementValue(tvElement);
    }

    function getInternetValue() {
      return getElementValue(internetElement);
    }

    function getMagazinesValue() {
      return getElementValue(magazinesElement);
    }

    function getElementValue(element) {
      let value = element.value;

      if (value === "") {
        value = 0;
      }

      value = parseFloat(value);

      if (value !== 0 && value % 50000 > 0) {
        value -= value % 50000;
      }

      return value;
    }

    function getTvPercentage() {
      return calculateTvPercentage(tvValue);
    }

    function getInternetPercentage() {
      return calculateInternetPercentage(internetValue);
    }

    function getMagazinesPercentage() {
      return calculateMagazinesPercentage(magazinesValue);
    }

    function calculateTvPercentage(tvValue) {
      return calculatePercentage(tvStats, tvValue, segment, "tv");
    }

    function calculateInternetPercentage(internetValue) {
      return calculatePercentage(
        internetStats,
        internetValue,
        segment,
        "internet"
      );
    }

    function calculateMagazinesPercentage(magazinesValue) {
      return calculatePercentage(
        magazinesStats,
        magazinesValue,
        segment,
        "magazines"
      );
    }

    function calculatePercentage(
      statsObj,
      statsObjKey,
      segmentName,
      segmentChannel
    ) {
      return parseFloat(
        statsObj[statsObjKey] * segments[segmentName][segmentChannel]
      );
    }

    function calculateCostEfficiency(percentage, value) {
      return parseFloat(((percentage / value || 0) * 50000).toFixed(4));
    }

    function validateBudgetLimit(current, max) {
      if (strictBudgetMatch) {
        return current == max;
      } else {
        return current <= max;
      }
    }

    function getBestPossibleRatio(e) {
      maxBudget = getBestResultBudgetElement.value;

      let bestTvEffAt = 0;
      let bestInternetEffAt = 0;
      let bestMagazinesEffAt = 0;

      let bestPossibleRatio = 0;

      for (const [tvKey, tvValue] of Object.entries(tvStats)) {
        let tvEff = calculateCostEfficiency(
          calculateTvPercentage(tvKey),
          tvKey
        );

        for (const [internetKey, internetValue] of Object.entries(
          internetStats
        )) {
          let internetEff = calculateCostEfficiency(
            calculateInternetPercentage(internetKey),
            internetKey
          );

          for (const [magazinesKey, magazinesValue] of Object.entries(
            magazinesStats
          )) {
            let magazinesEff = calculateCostEfficiency(
              calculateMagazinesPercentage(magazinesKey),
              magazinesKey
            );

            let overallCoverage =
              calculateTvPercentage(tvKey) +
              calculateInternetPercentage(internetKey) +
              calculateMagazinesPercentage(magazinesKey);

            let overallBudget =
              parseFloat(tvKey) +
              parseFloat(internetKey) +
              parseFloat(magazinesKey);

            let overallEff = (overallCoverage / overallBudget || 0) * 50000;

            let overallRatio = overallCoverage * overallEff;

            if (
              overallRatio > bestPossibleRatio &&
              validateBudgetLimit(overallBudget, maxBudget)
            ) {
              bestPossibleRatio = overallRatio;
              bestTvEffAt = tvKey;
              bestInternetEffAt = internetKey;
              bestMagazinesEffAt = magazinesKey;
            }
          }
        }
      }

      tvElement.value = bestTvEffAt;
      internetElement.value = bestInternetEffAt;
      magazinesElement.value = bestMagazinesEffAt;

      calculate();
    }

    function addStep(object) {
      let counter = 0;
      let prevKey = "0";
      Object.keys(object).forEach(key => {
        counter++;
        if (key === "0") {
          return;
        }
        if (counter >= 2) {
          let newKey = ((parseInt(prevKey) + parseInt(key)) / 2).toString();
          let newVal = parseFloat(
            ((object[prevKey] + object[key]) / 2).toFixed(3)
          );
          object[newKey] = newVal;
        }
        prevKey = key;
      });
      console.log(object);
    }
  </script>
</html>
